package cn.egame.common.web;

import java.io.BufferedReader;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.io.UnsupportedEncodingException;
import java.net.HttpURLConnection;
import java.net.URL;
import java.util.HashMap;
import java.util.Set;
import java.util.TreeMap;

import org.apache.log4j.Logger;

import cn.egame.common.exception.ExceptionCommonBase;
import cn.egame.common.util.Utils;

public class WebUtils {
	public enum HeaderProperty {
		Content_Type("Content-Type"), Connection("Connection"), User_Agent(
				"User-Agent"), Accept_Language("Accept-Language"), Refer(
				"Refer"), Cookie("Cookie"), Response("Response"),Host("Host"),req_log("req_log");

		private String value;

		private static TreeMap<Integer, HeaderProperty> _map;

		static {
			_map = new TreeMap<Integer, HeaderProperty>();
			int i = 0;
			for (HeaderProperty num : HeaderProperty.values()) {
				_map.put(new Integer(i++), num);
			}
		}

		public static HeaderProperty lookup(int value) {
			return _map.get(new Integer(value));
		}

		HeaderProperty(String value) {
			this.value = value;
		}

		public String value() {
			return this.value;
		}

		public String toString() {
			return value();
		}
	}

	static Logger logger = Logger.getLogger(WebUtils.class.getSimpleName());

	private static String getParams(HashMap<String, String> params,
			String charset) throws UnsupportedEncodingException {
		if (params != null) {
			StringBuilder sb = new StringBuilder();
			Set<String> keys = params.keySet();
			for (String key : keys) {
				sb.append("&" + key + "="
						+ java.net.URLEncoder.encode(params.get(key), charset));
			}
			return sb.toString();
		}
		return null;
	}

	public static String http(String urlStr, String method, String charset,
			HashMap<HeaderProperty, String> header,
			HashMap<String, String> params,
			HashMap<HeaderProperty, String> response)
			throws ExceptionCommonBase {

		if (Utils.stringIsNullOrEmpty(method))
			method = "POST";
		if (Utils.stringIsNullOrEmpty(charset))
			method = "utf-8";

		HttpURLConnection conn = null;
		BufferedReader in = null;
		try {
			URL url = new URL(urlStr);
			conn = (HttpURLConnection) url.openConnection();
			conn.setConnectTimeout(30 * 1000);
			conn.setRequestMethod(method);

			if (header == null) {
				header = new HashMap<HeaderProperty, String>();
			} else
				header.put(HeaderProperty.Content_Type,
						"application/x-www-form-urlencoded; charset=" + charset);
			setRequestProperty(conn, header);

			conn.setUseCaches(false);

			String data = getParams(params, charset);
			if (!Utils.stringIsNullOrEmpty(data)) {
				conn.setDoOutput(true);
				int dataLength = data.getBytes().length;
				conn.setRequestProperty("Content-Length",
						String.valueOf(dataLength));
				OutputStreamWriter out = new OutputStreamWriter(
						conn.getOutputStream(), charset);
				out.write(data);
				out.flush();
				out.close();
			}

			if (conn.getResponseCode() != HttpURLConnection.HTTP_OK) {
				throw new ExceptionWeb("HttpStatus:" + conn.getResponseCode());
			}

			if (response != null) {
				String key = null;
				String cookieVal = null;
				String sessionId = "";
				for (int i = 1; (key = conn.getHeaderFieldKey(i)) != null; i++) {
					// logger.info(key);
					if (key.equalsIgnoreCase("set-cookie")) {
						cookieVal = conn.getHeaderField(i);
						cookieVal = cookieVal.substring(0,
								cookieVal.indexOf(";"));
						sessionId = sessionId + cookieVal + ";";
					}
				}

				if (!Utils.stringIsNullOrEmpty(sessionId)) {
					response.put(HeaderProperty.Cookie, sessionId);
				}
			}

			String line = null;
			StringBuilder result = new StringBuilder();
			in = new BufferedReader(new InputStreamReader(
					conn.getInputStream(), charset));
			while ((line = in.readLine()) != null) {
				result.append(line + "\r\n");
			}

			return result.toString();

		} catch (Exception ex) {
			throw ExceptionCommonBase.throwExceptionCommonBase(ex);
		} finally {
			if (in != null)
				try {
					in.close();
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			if (conn != null)
				conn.disconnect();
		}
	}

	public static ByteArrayOutputStream httpStream(String urlStr,
			String method, String charset,
			HashMap<HeaderProperty, String> header,
			HashMap<String, String> params,
			HashMap<HeaderProperty, String> response)
			throws ExceptionCommonBase {

		if (Utils.stringIsNullOrEmpty(method))
			method = "POST";
		if (Utils.stringIsNullOrEmpty(charset))
			method = "utf-8";

		HttpURLConnection conn = null;
		InputStream is = null;
		try {
			URL url = new URL(urlStr);
			conn = (HttpURLConnection) url.openConnection();
			conn.setConnectTimeout(30 * 1000);
			conn.setRequestMethod(method);
			// conn.setInstanceFollowRedirects(true);

			if (header == null) {
				header = new HashMap<HeaderProperty, String>();
			} else
				header.put(HeaderProperty.Content_Type,
						"application/x-www-form-urlencoded; charset=" + charset);
			setRequestProperty(conn, header);

			conn.setUseCaches(false);

			String data = getParams(params, charset);
			if (!Utils.stringIsNullOrEmpty(data)) {
				conn.setDoOutput(true);
				int dataLength = data.getBytes().length;
				conn.setRequestProperty("Content-Length",
						String.valueOf(dataLength));
				OutputStreamWriter out = new OutputStreamWriter(
						conn.getOutputStream(), charset);
				out.write(data);
				out.flush();
				out.close();
			}

			if (conn.getResponseCode() != HttpURLConnection.HTTP_OK) {
				throw new ExceptionWeb("HttpStatus:" + conn.getResponseCode()
						+ " url=" + url);
			}

			if (response != null) {
				String key = null;
				String cookieVal = null;
				String sessionId = "";
				for (int i = 1; (key = conn.getHeaderFieldKey(i)) != null; i++) {
					if (key.equalsIgnoreCase("set-cookie")) {
						cookieVal = conn.getHeaderField(i);
						cookieVal = cookieVal.substring(0,
								cookieVal.indexOf(";"));
						sessionId = sessionId + cookieVal + ";";
					}
				}

				if (!Utils.stringIsNullOrEmpty(sessionId)) {
					response.put(HeaderProperty.Cookie, sessionId);
				}
			}

			is = conn.getInputStream();
			ByteArrayOutputStream byteStream = new ByteArrayOutputStream();
			int readLength = -1;
			int bufferSize = 1024 * 256;
			byte bytes[] = new byte[bufferSize];
			while ((readLength = is.read(bytes, 0, bufferSize)) != -1) {
				byteStream.write(bytes, 0, readLength);
				Thread.sleep(20);
			}

			return byteStream;
		} catch (Exception ex) {
			throw ExceptionCommonBase.throwExceptionCommonBase(ex);
		} finally {
			if (is != null)
				try {
					is.close();
				} catch (IOException e) {
					// TODO Auto-generated catch block
					e.printStackTrace();
				}
			if (conn != null)
				conn.disconnect();
		}
	}

	public static void main(String[] args) {

	}

	private static void setRequestProperty(HttpURLConnection conn,
			HashMap<HeaderProperty, String> header) {
		if (header == null) {
			conn.setRequestProperty(HeaderProperty.Content_Type.value(),
					"application/x-www-form-urlencoded; charset=utf-8");
			conn.setRequestProperty(HeaderProperty.Connection.value(),
					"Keep-Alive");
			conn.setRequestProperty(HeaderProperty.User_Agent.value(),
					"Mozilla/5.0 (Windows NT 5.1; rv:14.0) Gecko/20100101 Firefox/14.0.1");
			conn.setRequestProperty(HeaderProperty.Accept_Language.value(),
					"zh-CN");
		} else {

			Set<HeaderProperty> keys = header.keySet();
			for (HeaderProperty key : keys)
				conn.setRequestProperty(key.value(), header.get(key));

			if (!header.containsKey(HeaderProperty.Content_Type))
				conn.setRequestProperty(HeaderProperty.Content_Type.value(),
						"application/x-www-form-urlencoded; charset=utf-8");

			if (!header.containsKey(HeaderProperty.Connection))
				conn.setRequestProperty(HeaderProperty.Connection.value,
						"Keep-Alive");

			if (!header.containsKey(HeaderProperty.Accept_Language))
				conn.setRequestProperty(HeaderProperty.Accept_Language.value(),
						"zh-CN");

		}
	}

	public static String urlEncode(String str, String code) {
		try {
			return java.net.URLEncoder.encode(str, code);
		} catch (UnsupportedEncodingException e) {
			logger.error(e);
		}
		return null;
	}

	public static String urlDecode(String str, String code) {
		try {
			return java.net.URLDecoder.decode(str, code);
		} catch (UnsupportedEncodingException e) {
			logger.error(e);
		}
		return null;
	}

	public static String urlEncode(String str) {
		return urlEncode(str, "utf-8");
	}

	public static String urlDecode(String str) {
		return urlDecode(str, "utf-8");
	}
}